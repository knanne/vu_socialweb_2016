<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <style>
      
      rect.bordered {
        stroke: #ccc;
        stroke-width: 1px;
      }

      text.mono {
        font-size: 7pt;
        font-family: sans-serif;
        opacity: .8;
      }

      text.active {
        font-size: 12pt;
        font-family: sans-serif;
        opacity: 1;
        fill: red;
      }

      rect.cell-hover {
        stroke: red;
        stroke-width: 3px;
      }

      text.text-hover {
        font-size: 12pt;
        fill: black;
      }

      #tooltip {
        position: absolute;
        width: auto;
        height: auto;
        padding: 10px;
        background-color: white;
      }

      #tooltip.hidden {
        display: none;
      }

      #tooltip p {
        margin: 0;
        font-family: sans-serif;
        font-size: 12px;
        line-height: 20px;
      }

      #legend svg {
        background: #ECEFF1;
      }

      .legend text {
        font: 14px sans-serif;
      }

    </style>

    <div id="tooltip" class="hidden">
        <p><span id="value"></p>
    </div>
    
    <script src="http://d3js.org/d3.v3.js"></script>
  </head>
  <body>
    
    <div id="legend"></div>

    <div id="chart"></div>
    
    <script type="text/javascript">

      /*
      
      //READ CSV FILE
      function readTextFile(file) {
          var rawFile = new XMLHttpRequest();
          rawFile.open("GET", file, false);
          rawFile.onreadystatechange = function () {
              if(rawFile.readyState === 4) {
                  if(rawFile.status === 200 || rawFile.status == 0) {
                      var allText = rawFile.responseText;

                      docs = allText.split('\r\n');
                  }
              }
          }
          rawFile.send(null);
      }

      readTextFile('d3matrix_datacols.txt');
      console.log(links);

      */

      //LEGEND
      groups = ['CIW', 'CLTL', 'CS', 'CW', 'FSW', 'KIN', 'L&S'];

      var colorcat = d3.scale.category10();

      var legend = d3.select("#legend").append("svg")
        .attr("width", 50+groups.length*100)
        .attr("height", 40);

      legend = legend.selectAll(".legend")
        .data(d3.range(groups.length))
        .enter()
        .append("g")
        .attr("class", "legend");

      legend.append("circle")
          .attr("r", 10)
          .attr("cx", d3.scale.linear().domain([-.5,groups.length-.5]).range([0,groups.length*100]))
          .attr("cy", 20)
          .style("fill", function(d,i) { return colorcat(groups[i]); })
          .style("opacity", .8);

      legend.append("text")
          .attr("x", function(d,i) { return 60+(i*100); })
          .attr("y", 25)
          .text(function(d,i) {return groups[i]; });

      //MATRIX
      d3.tsv('d3matrix_datacols.txt', function(d) {
        return {
          title: d.title,
          group: d.group
        };
      },
      function(error, labels) {

        var margin = {top: 150, right: 50, bottom: 50, left: 150},
            width = 1800 - margin.left - margin.right,
            height = 1800 - margin.top - margin.bottom,
            gridSize = Math.floor(width / labels.length),
            legendElementWidth = gridSize*2;

        var svg = d3.select("#chart").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var rowLabels = svg.selectAll(".rowlabel")
            .data(labels)
            .enter().append("text")
              .text(function(d) { return d.title; })
              .attr("x", 0)
              .attr("y", function(d, i) { return i * gridSize; })
              .style("text-anchor", "end")
              .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
              .attr("class", function (d, i) { return "rowlabel mono r"+i; })
              .on("mouseover", function(d) {d3.select(this).classed("text-hover",true);})
              .on("mouseout" , function(d) {d3.select(this).classed("text-hover",false);});

        rowLabels.transition().duration(1000)
          .style("fill", function(d) {return colorcat(d.group); });


        var colLabels = svg.selectAll(".collabel")
            .data(labels)
            .enter().append("text")
              .text(function(d) { return d.title; })
              .attr("x", 0)
              .attr("y", function (d, i) { return i * gridSize; })
              .style("text-anchor", "left")
              .attr("transform", "translate(" + gridSize / 2 + ", -6) rotate (-90)")
              .attr("class", function(d, i) { return "collabel mono c"+i; })
              .on("mouseover", function(d) {d3.select(this).classed("text-hover",true);})
              .on("mouseout" , function(d) {d3.select(this).classed("text-hover",false);});

        colLabels.transition().duration(1000)
          .style("fill", function(d) {return colorcat(d.group); });

        d3.tsv('d3matrix_data.tsv', function(d) {
            return {
              link1: d.link1,
              link2: d.link2,
              value: +d.value
            };
          },
          function(error, data) {

            var colorScale = d3.scale.linear()
                .domain([0, .2, .7])
                .range(["#E1F5FE", "#FFD180", "#DD2C00"]);

            var cards = svg.selectAll(".link2")
                .data(data, function(d) {return d.link1+':'+d.link2;});

            cards.append("title");

            cards.enter().append("rect")
                .attr("x", function(d) { return (d.link2 - 1) * gridSize; })
                .attr("y", function(d) { return (d.link1 - 1) * gridSize; })
                .attr("rx", 4)
                .attr("ry", 4)
                .attr("class", "link2 bordered")
                .attr("width", gridSize)
                .attr("height", gridSize)
                .style("fill", "ccc")
                //.style("stroke", function(d,i) {return colorcat(labels[Math.floor(i/labels.length)].group); })
                .on("mouseover", function(d){
                   d3.select(this).classed("cell-hover",true);
                   d3.selectAll(".rowlabel").classed("active",function(r,ri){ return ri==d.link1-1; });
                   d3.selectAll(".collabel").classed("active",function(c,ci){ return ci==d.link2-1; });
            
                   //Update the tooltip position and value
                   d3.select("#tooltip")
                     .style("left", (d3.event.pageX+10) + "px")
                     .style("top", (d3.event.pageY-10) + "px")
                     .select("#value")
                     .html("<strong>"+labels[d.link1-1].title+"</strong>"+" : "+"<strong>"+labels[d.link2-1].title+"</strong>"+"<br>"+"similarity: "+d.value);  
                   d3.select("#tooltip").classed("hidden", false);
                })
                .on("mouseout", function(){
                    d3.select(this).classed("cell-hover",false);
                    d3.selectAll(".rowlabel").classed("active",false);
                    d3.selectAll(".collabel").classed("active",false);
                    d3.select("#tooltip").classed("hidden", true);
                  });

            cards.transition().duration(1000)
                .style("fill", function(d) { return colorScale(d.value); });
          });
      
      });

    </script>
  </body>
</html>